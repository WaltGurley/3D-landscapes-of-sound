<!DOCTYPE html>
<html>
  <head>
    <title>Audio Visualizer</title>
    <meta name="description" content="Audio Visualizer">
    <link rel="stylesheet" href="style.css">
    <script src="./delay-logging-FOR-TESTING.js"></script>
    <script src="https://aframe.io/releases/0.8.0/aframe.min.js"></script>
    <script src="https://rawgit.com/feiss/aframe-environment-component/master/dist/aframe-environment-component.min.js"></script>
    <script src="./aframe-audioanalyser-component.js"></script>
    <script src="./volume-scale-component.js"></script>
    <script>
      AFRAME.registerComponent('color-on-beat', {
        schema: {
          analyserEl: {type: 'selector'}
        },

        init: function () {
          var analyserEl = this.data.analyserEl || this.el;
          var el = this.el;

          analyserEl.addEventListener('audioanalyser-beat', function () {
            el.setAttribute('material', 'color', '#' + new THREE.Color(
              Math.random(), Math.random(), Math.random()
            ).getHexString());
          });
        }
      });

      AFRAME.registerComponent('ring-on-beat', {
        schema: {
          analyserEl: {type: 'selector'}
        },

        init: function () {
          var analyserEl = this.data.analyserEl || this.el;
          var el = this.el;
          var rings = this.rings = [];

          analyserEl.addEventListener('audioanalyser-beat', function () {
            var ringEl = document.createElement('a-ring');
            ringEl.setAttribute('material', 'opacity', '0.6');
            ringEl.setAttribute('position', '0 -0.5 0');
            ringEl.setAttribute('rotation', '-90 0 0');
            el.appendChild(ringEl);

            ringEl.addEventListener('loaded', function () {
              rings.push(ringEl);
              setTimeout(function () {
                el.removeChild(ringEl);
                rings.splice(rings.indexOf(ringEl), 1);
              }, 2000);
            });
          });
        },

        /**
         * Expand ring radii.
         */
        tick: function () {
          this.rings.forEach(function (ringEl) {
            var scale = ringEl.getAttribute('scale');
            ringEl.setAttribute('scale', {
              x: scale.x * 1.06 + .05,
              y: scale.y * 1.06 + .05,
              z: scale.z
            });
          });
        }
      });

      AFRAME.registerComponent('audio-terrain', {
        schema: {
          bands: {type: 'number', default: 6}, // number of bands in the terrain
          speed: {type: 'number', default: 1000}, // speed at which bands move along z-axis
          size: {type: 'vec3', default:{x:1, y:1, z:1} }
        },

        tick: function () {
          var analyserEl = this.data.analyserEl || this.el;
          var analyserComponent;
          var el = this.el;
          var volume;

          analyserComponent = analyserEl.components.audioanalyser;
          if (!analyserComponent.analyser) { return; }

          volume = analyserComponent.volume * this.data.multiplier;
          el.setAttribute('scale', {
            x: volume,
            y: 1,
            z: volume
          });
        }
      });

    </script>
  </head>
  <body>
    <a-scene>
      <a-assets>
        <audio id="song" src="WaltKevinBeat2.wav" crossorigin="anonymous" autoplay></audio>
      </a-assets>

      <a-box
        id='box1'
        color="#aaa"
        audioanalyser="src: #song"
        volume-scale="x: 0.24; z: 0.1"
        color-on-beat
        ring-on-beat
        position="0 2 -10"
        shadow
      ></a-box>

      <a-box
        id="box2"
        color="#aaa"
        audioanalyser="src: #song"
        volume-scale="x: 0.24; y: 0.5"
        color-on-beat
        ring-on-beat
        position="-5 0 -10"
        shadow
      ></a-box>

      <a-sky color="#ECECEC"></a-sky>
      <!-- <a-entity environment></a-entity> -->
    </a-scene>

    <div class="audio-controls">
      <button class="control pause-btn interact" type="button" name="pause-button">Pause</button>
      <div class="control volume-adjust">
        <h4 class="volume-label">Volume: </h4>
        <input type="range" class="volume-slider interact" name="volume-slider" min="0" max="1" value="0.02" step="0.025">
      </div>
    </div>
  </body>
  <script type="text/javascript" src="./audio-controls.js"></script>
</html>
